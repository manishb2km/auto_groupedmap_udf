[![N|Solid](data:image/png;base64,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)](https://nodesource.com/products/nsolid)

# Automatic schema generation for pandas_udf

auto_groupedmap_udf is a utility to enable agile development on pySpark grouped map pandas_udfs. This utility automatically generates schemas for grouped map udfs in pySpark on the fly.

## Features

- Automatic schema generation. No need to update the schema every time you make a change in your return dataframe
- Get lesser obscure and hard to understand spark errors and more explicit pandas errors. Allow easy debugging of the udf function by printing the actual error message in the udf function
- Automatic repartitioning of data to ensure faster runtimes
- Some automatic validation of the udf function results and warnings


## Installation

auto_groupedmap_udf requires Python v3.7+ to run. Not tested on earlier versions.

Install through pip

```sh
pip install auto_groupedmap_udf
```

## How to use

Below is an illustration through a simple function. You will have to define the schema as below

#### Old code
Let's say you have a simple pandas_udf function as below
```sh
def standardise_dataframe(df1: pd.DataFrame) -> pd.DataFrame:
    #df1.display()
    df1 = df1.groupby(['class','group']).sum()
    print(df1.head())
    return (df1)
  
schema = StructType([
    StructField('x', T.DoubleType(), nullable=False),
    StructField('y_lin', T.DoubleType(), nullable=False),
    StructField('y_qua', T.DoubleType(), nullable=False),
])

res = df.groupby(['class','group']).applyInPandas(standardise_dataframe, schema=schema)
```

#### New code
Let's say you have a simple pandas_udf function as below
```sh
import auto_groupedmap_udf
res = auto_groupedmap_udf(df=df, groupby_cols=['class','group'], func=standardise_dataframe,repartition_cols=['class','group'])
```

#### Additional utilities

1. Repartitioning - The utility repartitions the data basis the count of levels in the specified repartition cols and by the repartition cols
2. Debugging - In case you are in the experimentation phase and just want to see if your function works. You want to print something additional from within your udf which are not displayed while using pandas_udf
```sh
res.debug()
#this will also print any print statements inside your udf
#this will not run the actual pandas_udf on entire data
```
3. Get schema - In case you want to check just the autogenerated schema
```sh
res.get_schema()
```
4. Get warnings about possible obsure error messages in pySpark due to things like wrongly typed columns or nulls

## Caution
At the backend of this utility lies a mapping between pandas dtypes and pySpark data types. It is possible that certain type mappings are absent. In that case please create an issue in the repo.


## License
MIT

